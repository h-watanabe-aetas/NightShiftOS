# 全体機能仕様書（FSD）

## 1. システム機能一覧
| 機能ID | 機能名 | 概要 | 関連要求 |
|---|---|---|---|
| F-001 | 予兆検知イベント化 | Edgeの推定状態を標準イベント化 | PR-001, PR-007 |
| F-002 | 危険アラート配信 | Cloud判定でAppへプッシュ通知 | PR-001 |
| F-003 | スタッフ行動記録 | 入退室/手動ケアを時系列保存 | PR-002, PR-004 |
| F-004 | オフライン継続運用 | Edge/App双方で一時保持と再送 | PR-003 |
| F-005 | 監査証跡台帳 | Observation/Action/Deviation統合 | PR-004, PR-009 |
| F-006 | 施設設定管理 | 閾値・通知先・役割を管理UIで更新 | PR-005 |
| F-007 | レポート生成 | 日次/事故時証跡のPDF出力 | PR-006 |
| F-008 | センサー抽象化 | 機種差異を共通インタフェースで吸収 | PR-007 |

## 2. 主要ユースケース
### UC-01 危険予兆から訪室まで
1. Edgeが `SITTING` または `OUT_OF_BED` を生成。
2. Cloudが通知ルールを評価し、対象スタッフに `CRITICAL_ALERT` 送信。
3. Appが通知表示、スタッフが訪室。
4. Appが `ENTER` / `EXIT` / `CARE_*` を送信。
5. Cloudが対応時間を算出し監査台帳を更新。

### UC-02 オフライン時
1. Appはイベントをローカルキュー保存。
2. Edgeは検知継続、送信失敗はリングバッファに保持。
3. 回線回復後、時系列順で再送。

### UC-03 事故報告
1. 管理者が対象期間と居室を指定。
2. Cloudがセンサー/行動ログ/設定変更履歴を統合。
3. PDFと監査JSON（機械可読）を出力。

## 3. 状態モデル
### 3.1 被介護者状態（Edge起点）
- `SLEEP`
- `SITTING`
- `OUT_OF_BED`

### 3.2 スタッフ状態（App起点）
- `OFF_DUTY`
- `ON_DUTY_IDLE`
- `IN_ROOM`
- `RESPONDING`

## 4. イベント標準フォーマット
```json
{
  "event_id": "uuid-v7",
  "facility_id": "fac-xxx",
  "room_id": "201",
  "source": "edge|app|cloud",
  "event_type": "SITTING|OUT_OF_BED|ENTER|EXIT|CARE_TOILET|...",
  "occurred_at": "2026-02-10T01:23:45Z",
  "payload": {},
  "trace": {
    "device_id": "dev-xxx",
    "staff_id": "stf-xxx",
    "model_version": "edge-ml-0.3.1"
  }
}
```

## 5. 例外処理
- 重複イベント: `event_id` で冪等化。
- 時刻ずれ: サーバ受信時刻との差分を記録。
- 不正データ: `deviation_log` に隔離し運用画面で再判定。

## 6. 受入基準（機能）
- F-001: 遷移検知からイベント生成まで 500ms以内。
- F-002: 通知到達率 99%以上（FCM/APNs成功応答）。
- F-004: 30分断線後の再送欠落 0件。
- F-005: 任意インシデントを1分以内に再構成表示。
