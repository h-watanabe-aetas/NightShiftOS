# 全体機能仕様書（FSD）

## 1. 機能スコープ
本仕様は、全体PRDで定義された `PR-001` - `PR-015` を、実装可能な機能単位に分解したもの。

## 2. システムデータフロー
1. Edgeがレーダー解析から `SLEEP/SITTING/OUT` を生成。
2. EdgeがCloudへイベント送信し、同時にiBeaconを常時発信。
3. AppがRegion Monitoringで `ENTER/EXIT` を生成しCloudへ送信。
4. Cloudがセンサーとスタッフ行動を突合し、通知と監査証跡を更新。
5. 管理画面がRealtime購読でタイムライン更新、必要時PDF出力。

## 3. 機能一覧（全体）
| 機能ID | 機能名 | 入力 | 出力 | 関連要求 |
|---|---|---|---|---|
| F-001 | 状態推定イベント化 | Radarパケット | `SLEEP/SITTING/OUT` | PR-001, PR-007 |
| F-002 | 危険通知判定 | `sensor_events` | `notify-staff`呼び出し | PR-001, PR-005 |
| F-003 | 自動入退室記録 | Beaconイベント | `staff_movements` | PR-002 |
| F-004 | オフライン再送 | 未送信ログ | 一括再送結果 | PR-003 |
| F-005 | 証跡タイムライン構築 | Observation + Action | 統合時系列 | PR-004, PR-010 |
| F-006 | 施設分離アクセス制御 | JWT/Auth UID | Facility境界付き結果 | PR-006 |
| F-007 | 監査レポート生成 | 日付・施設指定 | PDF/JSON証跡 | PR-010 |
| F-008 | デバイス死活更新 | Edge通信 | `devices.last_seen/status` | PR-013 |
| F-009 | 施設設定反映 | 設定変更 | 閾値・通知条件更新 | PR-009 |
| F-010 | リアルタイム画面更新 | DB INSERTイベント | タイムライン再描画 | PR-014 |

## 4. 状態モデル
### 4.1 レジデント状態（Edge）
| 状態 | 判定条件 | 遷移備考 |
|---|---|---|
| SLEEP | 呼吸パケット受信、低体動 | 初回遷移時のみ通知可 |
| SITTING | 距離40-100cm かつ体動閾値超過 | 危険通知対象 |
| OUT | 5秒無信号 | 危険通知対象、即時遷移 |

### 4.2 スタッフ行動状態（App）
| 状態 | 発火条件 | 記録アクション |
|---|---|---|
| ENTER | didEnterRegion + minor特定 | `staff_movements.action=ENTER` |
| EXIT | didExitRegion | `staff_movements.action=EXIT` |
| CARE_* | 手動ボタン | `care_records` 追加 |

## 5. 主要ユースケース
### UC-01 危険検知から対応完了
1. Edgeが`SITTING`を送信。
2. Cloudが`notify-staff`を起動し高優先通知配信。
3. App通知受信後、スタッフが居室へ移動。
4. Appが`ENTER`自動記録。
5. ケア後に`CARE_TOILET`と`EXIT`を記録。
6. Cloudが対応時間を算出してタイムライン反映。

### UC-02 通信断シナリオ
1. Appは常に先保存（Store-and-Forward）。
2. 通信断中は`is_synced=false`で保持。
3. 接続回復/定期タスクでバッチ再送。
4. 成功時に`is_synced=true`または削除。

### UC-03 実地指導向け証跡出力
1. 管理者が日付と施設を指定。
2. Cloudが`sensor_events`と`staff_movements`を時系列結合。
3. サマリー（回数/平均対応時間）と明細をPDF出力。

## 6. インタフェース仕様（機能観点）
### 6.1 Edge -> Cloud
- Endpoint: `POST /functions/v1/ingest-sensor`
- 必須: `id, device_id, type, val`
- 認証: Device token（MVP）/将来JWT

### 6.2 App -> Cloud
- Endpoint: `POST /functions/v1/ingest-movement`
- 必須: `movements[]`（`id, minor, action, timestamp`）
- 認証: User JWT

## 7. エラー処理仕様
- 重複ID: `id`を冪等キーとして重複登録を防止。
- 施設不一致: RLSで0件応答または権限エラー。
- 通知対象なし: `No tokens`で正常終了し監査ログのみ記録。
- 時刻ずれ: `timestamp`と受信時刻差を監視指標化。

## 8. 受入基準
| TEST-ID | 観点 | 合格条件 |
|---|---|---|
| TEST-001 | Edge Beacon起動 | 電源投入から5秒以内に検知可能 |
| TEST-002 | Edge危険送信 | 着座から3秒以内にDB登録 |
| TEST-003 | App入室検知 | ロック中端末でローカル通知表示 |
| TEST-004 | Appオフライン再送 | 機内モード解除後に欠落なく反映 |
| TEST-005 | Cloud通知連鎖 | `SITTING`挿入1秒以内に通知処理開始 |
| TEST-006 | RLS隔離 | 他施設データ参照不可 |
| TEST-007 | 証跡PDF | 指定日レポートを出力可能 |
