# NightShiftOS 実装バックログ（MVP）

## 1. 運用ルール
- チケットID: `NS-<領域>-<連番>`（例: `NS-CLD-001`）
- 優先度: `P0`（必須）/`P1`（重要）/`P2`（改善）
- 見積: `S(0.5-1d) / M(2-3d) / L(4-6d) / XL(1w+)`
- ステータス: `Todo / In Progress / Review / Done`

## 2. フェーズ計画
### Phase 1（MVP必須）
- 目的: 予兆検知、通知、入退室記録、監査証跡の最小成立
- 完了条件:
  - 端座位/離床通知のE2Eが通る
  - 入退室ログ欠落率1%未満
  - 事故タイムラインPDFを出力可能

### Phase 2（運用品質）
- 目的: 劣化検知、設定運用、障害耐性向上

### Phase 3（証明可能データ基盤）
- 目的: Deviation管理とEvidence Pack拡張

## 3. エピック別バックログ
## Epic A: 基盤・共通（全体）
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-PLT-001 | 共通イベントスキーマ策定 | P0 | M | - | `TC-001`準拠JSON Schemaとサンプルを配置 |
| NS-PLT-002 | UUIDv7採番ユーティリティ | P0 | S | NS-PLT-001 | Edge/App/Cloudで同一形式採番 |
| NS-PLT-003 | トレーサビリティ運用手順化 | P1 | S | - | PR/F/TC変更時の更新手順を文書化 |

## Epic B: Edge
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-EDG-001 | UARTレーダードライバ実装 | P0 | L | NS-PLT-001 | `EF-001`のフレーム解析成功率>=99% |
| NS-EDG-002 | 3状態ステートマシン実装 | P0 | L | NS-EDG-001 | `SLEEP/SITTING/OUT_OF_BED`遷移テスト合格 |
| NS-EDG-003 | iBeacon常時広告実装 | P0 | M | - | 電源投入5秒以内広告開始、30分欠落なし |
| NS-EDG-004 | Cloud送信クライアント実装 | P0 | M | NS-PLT-001 | `POST /v1/edge/events`へ冪等送信 |
| NS-EDG-005 | 断線時リングバッファ再送 | P0 | M | NS-EDG-004 | 60分断線後の再送成功率>=99% |
| NS-EDG-006 | Provisioning（SoftAP） | P1 | M | NS-EDG-003 | `facility/room/wifi/threshold`保存可能 |
| NS-EDG-007 | OTAマネージャ実装 | P1 | L | NS-EDG-004 | 署名検証/失敗時ロールバック動作 |
| NS-EDG-008 | WDT/LED運用実装 | P1 | S | NS-EDG-002 | ハング時5秒以内復旧、LED輝度10%上限 |

## Epic C: Cloud
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-CLD-001 | DBスキーマ初版作成 | P0 | M | NS-PLT-001 | `events_raw/alerts/audit_ledger`作成 |
| NS-CLD-002 | `ingest_edge_fn`実装 | P0 | M | NS-CLD-001 | APIキー検証+保存+ルール起動 |
| NS-CLD-003 | `ingest_app_fn`実装 | P0 | M | NS-CLD-001 | JWT検証+バッチ冪等登録 |
| NS-CLD-004 | ルールエンジン実装 | P0 | L | NS-CLD-002 | `SITTING/OUT_OF_BED`通知判定動作 |
| NS-CLD-005 | Push Gateway実装 | P0 | M | NS-CLD-004 | FCM/APNs配信成功応答率>=99% |
| NS-CLD-006 | 監査台帳サービス実装 | P0 | L | NS-CLD-002,NS-CLD-003 | Observation/Action統合表示可能 |
| NS-CLD-007 | RLS/RBACポリシー実装 | P0 | M | NS-CLD-001 | 他施設越境アクセス0件 |
| NS-CLD-008 | レポート生成（PDF/JSON） | P1 | L | NS-CLD-006 | 24h分30秒以内で出力 |
| NS-CLD-009 | 設定管理API実装 | P1 | M | NS-CLD-001 | 変更履歴`config_history`に記録 |

## Epic D: App
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-APP-001 | 認証/初期化フロー実装 | P0 | M | NS-CLD-001 | ログイン後にfacility情報取得 |
| NS-APP-002 | Region Monitoring実装 | P0 | L | NS-APP-001 | Enter/Exit自動記録 |
| NS-APP-003 | Enter時Ranging補完実装 | P0 | M | NS-APP-002 | minor推定精度向上 |
| NS-APP-004 | オフラインキュー実装 | P0 | M | NS-APP-001,NS-CLD-003 | 100件再送欠落0 |
| NS-APP-005 | 重要通知ハンドラ実装 | P0 | M | NS-CLD-005 | 受信から2秒以内表示（P95） |
| NS-APP-006 | 手動ケア入力UI実装 | P1 | M | NS-APP-001 | 主要ケアを1タップ送信 |
| NS-APP-007 | 業務開始/終了トグル実装 | P1 | S | NS-APP-002 | OFFで監視停止 |
| NS-APP-008 | iOS/Android権限導線実装 | P0 | M | NS-APP-001 | 必須権限許可まで監視開始不可 |

## Epic E: Web/Admin
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-WEB-001 | リアルタイムタイムライン画面 | P1 | L | NS-CLD-002,NS-CLD-003 | 居室×時系列を1秒以内更新 |
| NS-WEB-002 | インシデント再構成画面 | P1 | M | NS-CLD-006 | 1件の事故を時系列復元可能 |
| NS-WEB-003 | 施設設定画面 | P1 | M | NS-CLD-009 | 閾値/通知先更新可能 |

## Epic F: QA/SRE/セキュリティ
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-QA-001 | E2E試験（Edge->Cloud->App） | P0 | L | NS-EDG-004,NS-CLD-005,NS-APP-005 | 主要シナリオ全通過 |
| NS-QA-002 | オフライン耐性試験 | P0 | M | NS-EDG-005,NS-APP-004 | 断線復帰時欠落0 |
| NS-QA-003 | RLS侵入試験 | P0 | M | NS-CLD-007 | 越境データ参照不可 |
| NS-QA-004 | パフォーマンス計測 | P1 | M | NS-CLD-004 | 通知遅延P95 3秒以内 |
| NS-SRE-001 | 監視ダッシュボード作成 | P1 | M | NS-CLD-002 | API/Push/DBアラート可視化 |

## 4. 実装順（推奨）
1. `NS-PLT-001` -> `NS-CLD-001` -> `NS-CLD-002/003`
2. 並行: `NS-EDG-001/002/003/004` と `NS-APP-001/002/004`
3. 接続: `NS-CLD-004/005` と `NS-APP-005`
4. 監査: `NS-CLD-006` -> `NS-WEB-002` -> `NS-CLD-008`
5. 品質ゲート: `NS-QA-001/002/003` 完了でMVPリリース判定

## 5. Definition of Done（共通）
- 実装: 仕様ID（PR/F/TC）へのリンクがPRに記載されている
- テスト: 単体/統合テストがCIでグリーン
- セキュリティ: 認可境界のネガティブテストがある
- 運用: メトリクス/ログが監視基盤に送られる
- 文書: 仕様差分が `docs/specs` に反映済み
