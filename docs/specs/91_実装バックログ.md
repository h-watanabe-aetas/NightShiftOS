# NightShiftOS 実装バックログ（再同期版）

## 1. 運用ルール
- チケットID: `NS-<領域>-<連番>`
- 優先度: `P0` 必須 / `P1` 重要 / `P2` 改善
- 見積: `S(0.5-1d) / M(2-3d) / L(4-6d) / XL(1w+)`
- 参照仕様: `00` - `33` と `90`

## 2. Phase定義
### Phase 1（MVP成立）
- 目的: `PR-001` `PR-002` `PR-003` `PR-004` `PR-006` `PR-010` を成立させる
- Exit:
  - `SITTING/OUT` 通知のE2E通過
  - 自動入退室 + オフライン再送通過
  - 証跡PDFが出力可能
  - RLS越境アクセス0件

### Phase 2（運用品質）
- 目的: 設定運用、可観測性、レポート品質の強化

### Phase 3（拡張準備）
- 目的: 拡張API、運用自動化、長期保全強化

## 3. エピック別バックログ
## Epic A: Platform / 全体基盤
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-PLT-001 | Event Contract v1定義 | P0 | M | - | `TC-001`準拠のJSON Schemaとサンプルを配置 |
| NS-PLT-002 | UUIDv7採番統一 | P0 | S | NS-PLT-001 | Edge/App/Cloudが同じUUIDv7実装を使用 |
| NS-PLT-003 | 用語統一ガード導入 | P0 | S | NS-PLT-001 | `OUT`と`OUT_OF_BED`の変換規約をテスト化 |
| NS-PLT-004 | トレーサビリティ更新フロー整備 | P1 | S | - | PR/F/TC/TEST変更時の更新手順を文書化 |

## Epic B: Edge
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-EDG-001 | BeaconTask実装 | P0 | M | NS-PLT-001 | 100ms広告と5秒以内起動を満たす |
| NS-EDG-002 | Radar UARTフレーム解析実装 | P0 | L | NS-PLT-001 | `53 59 ... 54 43`の有効フレーム抽出率>=99% |
| NS-EDG-003 | 状態遷移エンジン実装 | P0 | L | NS-EDG-002 | `SLEEP/SITTING/OUT`遷移とデバウンスが仕様通り |
| NS-EDG-004 | NetworkTask ingest-sensor送信実装 | P0 | M | NS-EDG-003 | `POST /functions/v1/ingest-sensor`へ冪等送信 |
| NS-EDG-005 | Wi-Fi非ブロッキング再接続実装 | P0 | M | NS-EDG-004 | 通信断中もBeacon/Radarタスク停止なし |
| NS-EDG-006 | Provisioning SoftAP + NVS実装 | P0 | M | NS-EDG-001 | `fac_id/room_id/ssid/pass/th_sit`保存と再起動反映 |
| NS-EDG-007 | WDT + LEDパターン実装 | P0 | M | NS-EDG-003 | ハング時5秒以内復旧と5パターンLED動作 |
| NS-EDG-008 | MQTT送信オプション実装 | P1 | M | NS-EDG-004 | topic `aetas/v1/devices/{dev_uuid}/events`送信可 |
| NS-EDG-009 | OTA更新実装 | P1 | L | NS-EDG-004 | 更新失敗時に旧バージョン継続 |

## Epic C: Cloud
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-CLD-001 | DDL初版作成 | P0 | M | NS-PLT-001 | `facilities/profiles/devices/sensor_events/staff_movements/care_records`作成 |
| NS-CLD-002 | RLSヘルパーとポリシー実装 | P0 | M | NS-CLD-001 | `get_my_facility_id()`と主要ポリシーが動作 |
| NS-CLD-003 | ingest-sensor実装 | P0 | M | NS-CLD-001 | `last_seen/status`更新と`sensor_events`登録が成功 |
| NS-CLD-004 | ingest-movement実装 | P0 | M | NS-CLD-001 | JWT検証とバッチ登録が成功 |
| NS-CLD-005 | notify-staff実装 | P0 | M | NS-CLD-003 | `SITTING/OUT`でFCM/APNs送信処理が起動 |
| NS-CLD-006 | Realtime publication設定 | P0 | S | NS-CLD-001 | `sensor_events`と`staff_movements`のINSERT購読可 |
| NS-CLD-007 | Evidence SQLとPDF生成実装 | P0 | L | NS-CLD-003,NS-CLD-004 | 日次レポートをPDFで出力可能 |
| NS-CLD-008 | profiles/auth bootstrap実装 | P1 | M | NS-CLD-001 | Staff/Adminログインとプロフィール参照可 |
| NS-CLD-009 | Functionsデプロイ/Secrets整備 | P1 | S | NS-CLD-003,NS-CLD-004,NS-CLD-005 | `FCM_SERVICE_ACCOUNT`設定と関数デプロイ完了 |
| NS-CLD-010 | PITRと運用監視初期設定 | P1 | S | NS-CLD-001 | バックアップと基本アラートが有効 |

## Epic D: App
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-APP-001 | Auth/初期化フロー実装 | P0 | M | NS-CLD-008 | `facility_id`取得完了まで監視開始しない |
| NS-APP-002 | 権限ウィザード実装 | P0 | M | NS-APP-001 | 位置情報常時/通知/Bluetooth導線を提供 |
| NS-APP-003 | Region Monitoring実装 | P0 | L | NS-APP-001 | enter/exit検知でイベント作成 |
| NS-APP-004 | Enter直後Ranging実装 | P0 | M | NS-APP-003 | RSSI最大minorを特定し`ENTER`に反映 |
| NS-APP-005 | Store-and-Forward実装 | P0 | M | NS-APP-001,NS-CLD-004 | 先保存後送信で欠落0 |
| NS-APP-006 | Sync Worker実装 | P0 | M | NS-APP-005 | 接続回復/定期/起動時の再送が動作 |
| NS-APP-007 | Critical通知ハンドラ実装 | P0 | M | NS-CLD-005 | 受信2秒以内表示と音/バイブ動作 |
| NS-APP-008 | Dashboard UI実装 | P1 | M | NS-APP-003 | 現在地カードと未送信件数表示 |
| NS-APP-009 | 手動ケアUI実装 | P1 | M | NS-APP-008 | 1タップで`CARE_*`記録を送信 |
| NS-APP-010 | iOS/Androidネイティブ設定反映 | P0 | M | NS-APP-002 | 必須manifest/plist/background設定が完了 |

## Epic E: Web / Admin
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-WEB-001 | Realtimeタイムライン画面実装 | P1 | L | NS-CLD-006 | 居室x時系列をリロードなし更新 |
| NS-WEB-002 | インシデント再構成画面実装 | P1 | M | NS-CLD-007 | 1件事故の時系列復元が可能 |
| NS-WEB-003 | EvidenceダウンロードUI実装 | P1 | M | NS-CLD-007 | 日付指定でPDF取得可 |
| NS-WEB-004 | 施設設定UI実装 | P2 | M | NS-CLD-001 | 閾値/通知設定を編集可能 |

## Epic F: QA / SRE / Security
| ID | タイトル | 優先 | 見積 | 依存 | 受入条件 |
|---|---|---|---|---|---|
| NS-QA-001 | Alert Loop E2E試験 | P0 | L | NS-EDG-004,NS-CLD-005,NS-APP-007 | `SITTING/OUT`から通知までE2E通過 |
| NS-QA-002 | Auto Check-in E2E試験 | P0 | M | NS-EDG-001,NS-APP-003,NS-CLD-004 | Enter/Exitが時系列で記録される |
| NS-QA-003 | Offline再送試験 | P0 | M | NS-APP-006,NS-CLD-004 | 機内モード往復で欠落0 |
| NS-QA-004 | RLS侵入試験 | P0 | M | NS-CLD-002 | 他施設データ参照不可 |
| NS-QA-005 | 通知遅延性能試験 | P1 | M | NS-CLD-005 | 通知遅延P95<=5秒 |
| NS-QA-006 | Appバッテリー計測 | P1 | S | NS-APP-003 | 消費増2%/h目標を検証 |
| NS-SRE-001 | 監視ダッシュボード整備 | P1 | M | NS-CLD-010 | API/Functions/Push/DBメトリクス可視化 |

## 4. 推奨実装順
1. Platform: `NS-PLT-001` -> `NS-PLT-002` -> `NS-PLT-003`
2. Cloud基盤: `NS-CLD-001` -> `NS-CLD-002` -> `NS-CLD-003/004`
3. Edge/App並行:
   - Edge: `NS-EDG-001/002/003/004/006/007`
   - App: `NS-APP-001/002/003/004/005/006`
4. 通知/可視化: `NS-CLD-005/006/007` -> `NS-APP-007` -> `NS-WEB-001/002/003`
5. 品質ゲート: `NS-QA-001/002/003/004` 完了でMVP判定

## 5. Definition of Done
- 仕様リンク: PR/F/TC/TESTの参照をPR本文に記載
- テスト: 該当TEST-IDがCIまたは手順書で検証済み
- セキュリティ: 認可境界と権限不足ケースを検証済み
- 運用: ログと主要メトリクスが収集される
- 文書: 仕様差分を`docs/specs`へ反映済み
