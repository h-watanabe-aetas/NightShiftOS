# 全体技術設計書（TDD）

## 1. 設計方針
- 3層（Edge/App/Cloud）を疎結合で接続する。
- 危険通知は遅延最小、監査証跡は欠落最小を優先する。
- MVPは実装速度重視でSupabase中心構成、将来拡張を阻害しない。

## 2. ハイレベルアーキテクチャ
| 層 | ランタイム | 主責務 | 通信 |
|---|---|---|---|
| Edge | ESP32 FreeRTOS | レーダー解析、Beacon発信、イベント送信 | BLE, HTTPS（MVP必須）/MQTT（オプション） |
| App | Flutter | 入退室検知、通知受信、オフライン同期 | HTTPS, FCM/APNs |
| Cloud | Supabase | 認証、DB、Functions、Realtime | HTTPS, Postgres protocol |

## 3. 技術コンポーネント
| TC-ID | 名称 | 実装責務 | 主データ |
|---|---|---|---|
| TC-001 | Event Contract | Edge/Appイベント共通フォーマット定義 | `id, type, ts` |
| TC-002 | Alert Router | 危険イベント判定と通知分岐 | `sensor_events` |
| TC-003 | Timeline Assembler | ObservationとAction連結 | `sensor_events + staff_movements` |
| TC-004 | Tenant Guard | RLS関数とポリシー適用 | `profiles.facility_id` |
| TC-005 | Report Builder | PDF/JSON証跡生成 | 集計SQL結果 |
| TC-006 | Delivery Monitor | 通知遅延・再送率を可視化 | 運用メトリクス |

## 4. データ契約
### 4.1 Edgeイベント
```json
{
  "id": "uuid-v7",
  "device_id": "uuid",
  "type": "SLEEP|SITTING|OUT",
  "val": { "dist": 0.8, "energy": 95 },
  "timestamp": 1709280000
}
```

### 4.2 App行動イベント
```json
{
  "movements": [
    {
      "id": "uuid-v7",
      "minor": 201,
      "action": "ENTER|EXIT|CARE_*",
      "timestamp": "2026-02-10T02:00:00Z",
      "rssi": -65
    }
  ]
}
```

## 5. API設計
- `POST /functions/v1/ingest-sensor`
  - 認証: Device token（MVP）
  - 処理: `devices.last_seen`更新 -> `sensor_events`挿入 -> 条件一致時`notify-staff`
- `POST /functions/v1/ingest-movement`
  - 認証: User JWT
  - 処理: `auth.uid()`検証 -> `ENTER/EXIT`は`staff_movements`保存、`CARE_*`は`care_records`保存
  - 備考: `staff_id` はJWT由来で確定し、payloadからは受け取らない
- `POST /functions/v1/notify-staff`（内部呼び出し）
  - 処理: facility別token取得 -> FCM/APNsマルチキャスト

## 6. シーケンス（要約）
### 6.1 危険通知ループ
1. Edgeで`SITTING`検知。
2. Cloud IngestがDB保存。
3. Cloudが通知関数起動。
4. Appが高優先通知受信。

### 6.2 自動チェックイン
1. App OSがBeacon enterを検知。
2. Appが短時間rangingでminor特定。
3. ローカル保存後にCloud同期。

## 7. セキュリティ設計
### 7.1 認証
- App: Supabase Auth JWT
- Edge: MVPは共有トークン、将来はデバイス個別証明

### 7.2 認可
- 全主要テーブルでRLS有効化
- `auth.uid() -> profiles.facility_id`で施設境界を確定

### 7.3 データ保護
- 通信はTLS1.2以上
- 監査対象操作（設定変更/エクスポート）を記録

## 8. デプロイ・運用設計
### 8.1 環境
- Development: Supabase CLI/開発プロジェクト
- Production: Supabase本番プロジェクト

### 8.2 環境変数（代表）
- `SUPABASE_URL`
- `SUPABASE_SERVICE_ROLE_KEY`
- `FCM_SERVICE_ACCOUNT`

### 8.3 デプロイ手順（Cloud）
1. DB DDL/RLSを適用
2. secretsを投入
3. `ingest-sensor`/`ingest-movement`/`notify-staff`をデプロイ
4. Realtime Publicationを有効化

## 9. 可観測性
- SLI:
  - 危険通知遅延（検知時刻 -> 端末受信時刻）
  - 入退室欠落率
  - 再送成功率
  - RLS拒否件数
- アラート:
  - API error率>1%
  - 通知失敗率>2%
  - 1分間通知ゼロ（要調査）

## 10. テスト戦略
| 区分 | 観点 | 代表ケース |
|---|---|---|
| Unit | 状態遷移/冪等処理 | 重複ID送信時に二重登録しない |
| Integration | E2E通知 | `SITTING`挿入で通知起動 |
| Security | RLS | 他施設データ参照不可 |
| Resilience | 断線復帰 | App/Edge再送で欠落なし |
