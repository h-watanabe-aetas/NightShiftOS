# 全体技術設計書（TDD）

## 1. 論理アーキテクチャ
- Edge: センサー取得・状態推定・Beacon送信・イベント送信
- Cloud: API/ルールエンジン/DB/監査台帳/通知
- App: バックグラウンド検知・通知受信・手動記録・オフライン同期

## 2. コンポーネント設計
| TC-ID | コンポーネント | 役割 |
|---|---|---|
| TC-001 | Event Contract | 全イベント共通スキーマ |
| TC-002 | Alert Router | 優先度・担当・再通知判定 |
| TC-003 | Audit Ledger | 監査証跡統合ストア |
| TC-004 | Config Service | 施設設定・反映管理 |
| TC-005 | Report Builder | PDF/JSON証跡生成 |
| TC-006 | Observability | メトリクス/ログ/トレース |

## 3. データモデル（共通）
- `events_raw`: 生イベント（append-only）
- `events_normalized`: 正規化済みイベント
- `incident_timeline`: インシデント単位の連結ビュー
- `deviation_log`: 欠損/逸脱/不整合
- `config_audit_log`: 設定変更監査

## 4. API設計（外部公開）
- `POST /v1/edge/events`
- `POST /v1/app/movements/batch`
- `POST /v1/app/care-records`
- `GET /v1/incidents/{id}/timeline`
- `POST /v1/reports/evidence`
- `GET /v1/config/facilities/{id}`
- `PUT /v1/config/facilities/{id}`

## 5. セキュリティ設計
- 認証: Edgeはデバイスキー、App/AdminはJWT（OIDC）
- 認可: RBAC + Facility単位RLS
- 暗号化: TLS1.3、保存時AES-256
- 監査: 認証/認可失敗・設定変更・エクスポートを全記録

## 6. 可観測性
- SLI: 通知遅延、欠落率、再送率、アラート対応時間
- SLO違反時: Pager通知 + 自動Runbookリンク

## 7. テスト戦略
- Unit: 状態遷移/ルール評価/冪等処理
- Integration: Edge->Cloud->AppのE2E通知
- Chaos: Cloud停止/ネットワーク断
- Security: 認可境界、RLS漏洩検証
