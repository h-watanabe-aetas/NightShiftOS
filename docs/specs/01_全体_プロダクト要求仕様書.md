# 全体プロダクト要求仕様書（PRD）

## 1. 文書情報
- プロダクト名: NightShiftOS (Project Aetas "Defender")
- 対象: MVP（施設PoC向け）
- 参照元: 全体PRD v6.0 / 全体FSD v1.0 / 全体TDD v1.0

## 2. 背景と課題
介護夜勤は以下の二律背反を抱える。
- 人材不足により、少人数で広範囲を見守る必要がある。
- 事故時は、巡回・対応の客観的証跡を求められる。

現状課題:
- 既存センサーは誤報が多く、空振り訪室が夜勤者を疲弊させる。
- 実地指導・訴訟対応で提出できる時系列証跡が不足する。

## 3. ビジョンと提供価値
### 3.1 ビジョン
「夜勤を、守る。」

### 3.2 価値提供
- 現場: 危険時のみ呼ばれるトリアージ運用（空振り削減）
- 経営: 行動証跡の自動化（監査・法的防衛）

### 3.3 タグライン
「行くべき時だけ通知し、行った事実は自動で残る」

## 4. システム境界
### 4.1 コンポーネント
- NightShift Edge（The Eye）: 危険予兆検知 + iBeacon送信
- NightShift App（The Hand）: 入退室記録 + 通知受信 + ケア記録
- NightShift Cloud（The Brain）: 統合・判定・監査証跡・レポート

### 4.2 技術スタック（MVP）
- Edge: XIAO ESP32C6 + MR60BHA2
- App: Flutter（iOS 16+/Android 12+）
- Cloud: Supabase（Auth/DB/Functions/Realtime）

## 5. 代表ユースケース（夜間2時シナリオ）
1. Edgeが端座位を検知し `SITTING` をCloud送信。
2. Cloudが高優先通知をスタッフへ一斉配信。
3. スタッフが居室へ移動すると、AppがBeaconで自動入室記録。
4. ケア実施後、Appで1タップ記録して退室。
5. Cloudのタイムラインに「警告->入室->介入->退室」が連結保存。

## 6. 要求一覧
| ID | 要求 | 優先 | 検証可能な受入条件 | 主要ソース |
|---|---|---|---|---|
| PR-001 | 危険予兆をリアルタイム通知 | Must | `SITTING/OUT` 発生から通知到達5秒以内（P95） | 全体PRD 4.1/4.3 |
| PR-002 | 入退室を自動記録 | Must | 監視ON時のENTER/EXIT欠落率1%未満 | 全体PRD 4.2 |
| PR-003 | Cloud障害時も現場機能維持 | Must | Edge検知とAppローカル保存が継続 | 全体FSD 2.3/3.3 |
| PR-004 | 監査証跡を自動再構成 | Must | アラートから退室まで時系列復元可能 | 全体PRD 3 / 4.3 |
| PR-005 | 危険時の強通知 | Must | High priority通知 + 音/バイブで通知 | 全体PRD 4.2 |
| PR-006 | RLSによる施設分離 | Must | 他施設データのSELECT不可 | 全体PRD 4.3 / 全体FSD 6.2 |
| PR-007 | 不変の事実ログ保持 | Must | `sensor_events`のUPDATE/DELETE運用禁止 | 全体PRD 5 |
| PR-008 | カメラ/マイク非搭載 | Must | 製品仕様とBOMに明示、実機検証可能 | 全体PRD 6 |
| PR-009 | 導入容易性 | Should | 初期設定を現地で短時間実施可能 | 全体PRD 6 |
| PR-010 | PDF監査レポート出力 | Must | 指定日で業務日誌相当PDFを生成 | 全体PRD 4.3 / FSD 4.3 |
| PR-011 | UUID v7中心の時系列ID | Must | クライアント生成IDが時系列整列可能 | 全体PRD 5 |
| PR-012 | Appバッテリー負荷最小化 | Must | GPS未使用、増加2%/h以下を目標 | 全体FSD 6.1 |
| PR-013 | Edge自己復旧 | Must | WDTで5秒以内に復旧 | 全体PRD 6 / FSD 2.4 |
| PR-014 | リアルタイム管理画面 | Should | リロードなしで最新イベント反映 | 全体PRD 4.3 |
| PR-015 | 1か月でAlpha PoC成立 | Must | Week1-4成果物を揃えてPoC開始 | 全体PRD 7 |

## 7. 非機能要件
### 7.1 信頼性
- Edgeは24時間365日稼働前提。
- Wi-Fi切断からの自動復旧を実装する。

### 7.2 性能
- 危険検知から通知まで5秒以内（P95）。
- ダッシュボード更新は1秒以内の体感反映を目標。

### 7.3 プライバシー
- カメラ・マイク不使用。
- 個人追跡目的のGPS利用なし（AppはBeacon中心）。

### 7.4 セキュリティ
- App: JWT認証。
- Edge: MVPはデバイストークン、将来はmTLS/JWT個別化。
- Cloud: RLSで施設境界を強制。

## 8. スコープ定義
### 8.1 MVP In Scope
- 端座位/離床検知
- 入退室自動記録
- 高優先通知
- 監査タイムライン/証跡PDF

### 8.2 MVP Out of Scope
- 高度な予兆AI学習自動化
- 保険請求システム統合
- グローバル多言語対応

## 9. ロードマップ（4週間）
- Week 1: Edge基盤（呼吸検知 + Beacon同時動作）
- Week 2: App基盤（バックグラウンド入室記録）
- Week 3: Cloud基盤（通知までE2E）
- Week 4: Dashboard + 安定性試験

## 10. リスク
- iOSバックグラウンド起動はOS裁量がある。
- 居室環境差で端座位閾値の再調整が必要。
- 施設ネットワーク品質差で再送設計が重要。

## 11. 受入判定（MVP Exit Criteria）
- `SITTING` イベントで通知が確実に到達する。
- 入退室とケア記録が同一タイムラインに並ぶ。
- 監査用PDFが実地指導想定で説明可能品質を満たす。
