# NightShiftOS 仕様前提・整合方針

## 1. 目的
本書は、`NightShiftOSプロダクト要求仕様書（全体）` フォルダ内のDOCX群を初期一次情報として、`docs/specs`配下のMarkdown仕様群を実装正本として運用するための整合ルールを定義する。

## 2. 参照元DOCX
| 領域 | PRD | FSD | TDD |
|---|---|---|---|
| 全体 | `NightShiftOSプロダクト要求仕様書（全体）.docx` | `NightShiftOS機能仕様書(全体).docx` | `NightShiftOS技術設計書(全体).docx` |
| Edge | `NightShiftOSプロダクト要求仕様書（エッジデバイス）.docx` | `NightShiftOS機能仕様書 (エッジデバイス).docx` | `NightShiftOS技術設計書 (エッジデバイス).docx` |
| Cloud | `NightShiftOSプロダクト要求仕様書（Cloud）.docx` | `NightShiftOS機能仕様書 (Cloud).docx` | `NightShiftOS技術設計(Cloud).docx` |
| App | `NightShiftOSプロダクト要求仕様書（App）.docx` | `NightShiftOS機能仕様書(App).docx` | `NightShiftOS技術設計書 (App).docx` |

## 3. 仕様正本の優先順位
1. ドメイン固有のTDD（実装詳細）
2. ドメイン固有のFSD（機能振る舞い）
3. ドメイン固有のPRD（要求）
4. 全体TDD/FSD/PRD（共通原則）
5. 本整合方針書

## 4. 用語定義
- NightShift Edge: 居室内で危険予兆を検知し、Beaconを発信するデバイス層。
- NightShift App: スタッフの入退室とケア行動を記録するモバイル層。
- NightShift Cloud: データ統合・通知・監査証跡生成を担うクラウド層。
- Observation: センサー事実ログ（例: `SLEEP/SITTING/OUT`）。
- Action: スタッフ行動ログ（例: `ENTER/EXIT/CARE_TOILET`）。
- Evidence: ObservationとActionを時系列で再構成した監査証跡。

## 5. ID体系
- 全体要求: `PR-xxx`
- Edge要求: `ER-xxx`
- Cloud要求: `CR-xxx`
- App要求: `AR-xxx`
- 全体機能: `F-xxx`
- Edge機能: `EF-xxx`
- Cloud機能: `CF-xxx`
- App機能: `AF-xxx`
- 全体技術項目: `TC-xxx`
- Edge技術項目: `ETC-xxx`
- Cloud技術項目: `CTC-xxx`
- App技術項目: `ATC-xxx`
- 検証項目: `TEST-xxx`

## 6. 競合記載の統一方針
DOCX間で名称差分がある項目は以下で統一する。

| 対象 | 記載ゆれ | 統一値 |
|---|---|---|
| App行動ログテーブル | `staff_actions` / `staff_movements` | `staff_movements` |
| App受信API | `ingest-action` / `ingest-movement` | `ingest-movement` |
| Edge送信プロトコル | MQTT または HTTPS | MVPはHTTPS必須、MQTTはオプション |
| イベント型 | `OUT` / `OUT_OF_BED` | 永続化は`OUT`、内部状態名は`OUT_OF_BED` |
| UUID生成 | v7推奨 + v4デフォルト | クライアント生成はv7必須、DBはv4フォールバック許容 |
| App送信者識別 | payloadに`staff_id`を含む / 含まない | payloadは`staff_id`を含めず`auth.uid()`で確定 |
| ケア記録保存先 | `staff_movements.action=CARE_*` / `care_records` | 正本は`care_records`、必要時のみ`staff_movements`へ派生記録 |
| 時刻フィールド | `ts` / `timestamp` / `created_at` | API入力は`timestamp`、DB保存時は`created_at`へ正規化 |

## 7. 非機能要件の基準値
- 危険検知から通知到達: 5秒以内（P95）
- Edge Beacon開始: 電源投入から5秒以内
- Appバッテリー増加: 1時間あたり2%以下（GPS未使用前提）
- Cloud可用性: 99.9%/月（MVP目標）
- 監査証跡再構成: 1件を60秒以内に表示

## 8. 変更管理ルール
- 要求変更時は `01/11/21/31` を先に更新する。
- 機能変更時は `02/12/22/32` と `90_トレーサビリティマトリクス.md` を同時更新する。
- 実装詳細変更時は `03/13/23/33` を更新し、該当テストIDを追記する。
- 実装順序や依存を変更した場合は `91_実装バックログ.md` と `92_github_issues.csv` を同時更新する。
- DOCXへの逆同期が必要な場合は、Markdown更新後に差分同期を行う（MVP開発中はMarkdownを優先）。
- 競合記載が再発した場合は本書6章を更新して基準を固定する。
